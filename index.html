<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>eDrawings Upload Portal</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  :root{
    --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --accent:#111827;
    --green:#10b981; --red:#ef4444; --link:#2563eb;
  }
  html,body{height:100%;margin:0;background:var(--bg);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{display:grid;grid-template-rows:1fr 1fr;min-height:100vh;gap:16px;padding:16px;box-sizing:border-box}
  .card{background:var(--card);border-radius:16px;box-shadow:0 10px 30px rgba(0,0,0,.06);padding:20px;display:flex;flex-direction:column}
  .row{display:flex;gap:16px;align-items:center;flex-wrap:wrap}
  h1{margin:0 0 6px 0;font-size:20px}
  .muted{color:var(--muted)}
  .btn{appearance:none;border:none;background:var(--accent);color:white;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn[disabled]{opacity:.5;cursor:not-allowed}
  .btn.alt{background:#374151}
  .btn.copy{background:var(--green)}
  .link{color:var(--link);text-decoration:none}
  .dropzone{
    flex:1;min-height:240px;border:2px dashed #d1d5db;border-radius:14px;background:#fafafa;
    display:flex;align-items:center;justify-content:center;text-align:center;padding:20px
  }
  .dropzone.drag{background:#eef2ff;border-color:#93c5fd}
  .fileline{display:flex;align-items:center;gap:10px;margin-top:12px;word-break:break-all}
  .grid{overflow:auto;margin-top:12px;border:1px solid #e5e7eb;border-radius:12px}
  table{border-collapse:collapse;width:100%}
  th,td{padding:10px 12px;border-bottom:1px solid #f1f5f9;text-align:left}
  th{background:#f8fafc;font-weight:600;font-size:14px}
  .status{min-height:22px;color:var(--muted);margin-top:8px}
  .chip{display:inline-block;padding:2px 8px;border-radius:999px;background:#f1f5f9;color:#111827;font-size:12px}
  .right{margin-left:auto}
  .token-input{flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px;font-family:monospace;font-size:14px}
  .login-form{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .help-text{background:#f8fafc;padding:12px;border-radius:8px;margin-top:12px;font-size:14px}
  .help-text a{color:var(--link)}
</style>
</head>
<body>
<div class="wrap">

  <!-- TOP: Upload area -->
  <section class="card" id="top">
    <div class="row">
      <div>
        <h1>Upload eDrawings HTML</h1>
        <div class="muted">Drag & drop your <strong>.html</strong> file below. You'll get a shareable link immediately.</div>
      </div>
      <div class="right row">
        <span id="userBadge" class="chip">Not signed in</span>
        <button id="logoutBtn" class="btn alt" style="display:none">Sign out</button>
      </div>
    </div>

    <!-- Login form -->
    <div id="loginSection" class="login-form">
      <input id="tokenInput" type="password" placeholder="Paste your GitHub Personal Access Token here" class="token-input" />
      <button id="loginBtn" class="btn">Sign in</button>
    </div>

    <!-- Help text -->
    <div id="helpText" class="help-text">
      <strong>How to get your token:</strong><br>
      1. Go to <a href="https://github.com/settings/tokens?type=beta" target="_blank">GitHub Settings → Personal access tokens</a><br>
      2. Click "Generate new token (fine-grained)"<br>
      3. Select your repository: <strong>handrailcreations/edrawings</strong><br>
      4. Give it "Contents" permission (read/write)<br>
      5. Copy the token and paste it above
    </div>

    <div id="dropzone" class="dropzone" style="display:none">
      <div>
        <div style="font-size:18px;margin-bottom:6px">Drop your <b>eDrawings .html</b> file here</div>
        <div class="muted">…or click to choose a file</div>
      </div>
      <input id="fileInput" type="file" accept=".html" style="display:none" />
    </div>

    <div class="fileline" id="selectedFile" style="display:none"></div>

    <div class="row" id="afterUpload" style="display:none">
      <input id="shareUrl" type="text" readonly style="flex:1;padding:10px;border:1px solid #e5e7eb;border-radius:10px" />
      <button id="copyBtn" class="btn copy">Copy link</button>
      <a id="openBtn" class="btn" href="#" target="_blank">Open</a>
    </div>

    <div class="status" id="status"></div>
  </section>

  <!-- BOTTOM: Recent uploads -->
  <section class="card">
    <div class="row">
      <h1 style="margin:0">Recent uploads</h1>
      <button id="refreshBtn" class="btn alt right">Refresh</button>
    </div>
    <div class="grid">
      <table>
        <thead>
          <tr><th>File</th><th>Uploader</th><th>Date</th><th>Link</th></tr>
        </thead>
        <tbody id="recentTbody">
          <tr><td colspan="4" class="muted">Loading…</td></tr>
        </tbody>
      </table>
    </div>
  </section>

</div>

<script>
/* =========================
   CONFIG — SET THESE FIRST
   ========================= */
// Your GitHub org/user and repo that holds the HTML files
const GH_OWNER = 'handrailcreations';
const GH_REPO  = 'edrawings';
// The public base URL where Pages serves the files
const PAGES_BASE = 'https://handrailcreations.github.io/edrawings/';

const els = {
  dz: document.getElementById('dropzone'),
  fi: document.getElementById('fileInput'),
  sel: document.getElementById('selectedFile'),
  tokenInput: document.getElementById('tokenInput'),
  loginBtn: document.getElementById('loginBtn'),
  loginSection: document.getElementById('loginSection'),
  helpText: document.getElementById('helpText'),
  logout: document.getElementById('logoutBtn'),
  userBadge: document.getElementById('userBadge'),
  status: document.getElementById('status'),
  shareUrl: document.getElementById('shareUrl'),
  copyBtn: document.getElementById('copyBtn'),
  openBtn: document.getElementById('openBtn'),
  afterUpload: document.getElementById('afterUpload'),
  recentTbody: document.getElementById('recentTbody'),
  refreshBtn: document.getElementById('refreshBtn'),
};

/* ---------- Token storage ---------- */
function setToken(t){sessionStorage.setItem('gh_token', t)}
function getToken(){return sessionStorage.getItem('gh_token')}
function clearToken(){sessionStorage.removeItem('gh_token')}

/* ---------- Auth UI ---------- */
function setSignedIn(user){
  els.userBadge.textContent = user ? `Signed in: ${user.login}` : 'Not signed in';
  els.loginSection.style.display = user ? 'none' : '';
  els.helpText.style.display = user ? 'none' : '';
  els.logout.style.display = user ? '' : 'none';
  els.dz.style.display = user ? '' : 'none';
}

/* ---------- Login with token ---------- */
async function loginWithToken(){
  const token = els.tokenInput.value.trim();
  if(!token){
    els.status.textContent = 'Please enter a GitHub Personal Access Token';
    return;
  }

  els.status.textContent = 'Verifying token...';
  els.loginBtn.disabled = true;

  try {
    // Test the token by getting user info
    const response = await fetch('https://api.github.com/user', {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Accept': 'application/vnd.github+json'
      }
    });

    if (!response.ok) {
      if (response.status === 401) {
        throw new Error('Invalid token. Please check your token and try again.');
      }
      throw new Error(`GitHub API error: ${response.status}`);
    }

    const user = await response.json();
    
    // Test repository access
    const repoResponse = await fetch(`https://api.github.com/repos/${GH_OWNER}/${GH_REPO}`, {
      headers: {
        'Authorization': 'Bearer ' + token,
        'Accept': 'application/vnd.github+json'
      }
    });

    if (!repoResponse.ok) {
      throw new Error(`Cannot access repository ${GH_OWNER}/${GH_REPO}. Make sure your token has access to this repository.`);
    }

    // Success!
    setToken(token);
    setSignedIn(user);
    els.status.textContent = `Successfully signed in as ${user.login}!`;
    els.tokenInput.value = '';
    
    // Load recent uploads
    renderRecent();

  } catch (error) {
    els.status.textContent = error.message;
  } finally {
    els.loginBtn.disabled = false;
  }
}

/* ---------- GitHub API helpers ---------- */
async function gh(path, opts={}){
  const token = getToken();
  const headers = { 'Accept':'application/vnd.github+json' };
  if(token) headers['Authorization'] = 'Bearer ' + token;
  return fetch(`https://api.github.com${path}`, {headers, ...opts});
}

async function getUser(){
  const t = getToken();
  if(!t) return null;
  try {
    const r = await gh('/user');
    if(!r.ok) {
      clearToken();
      return null;
    }
    return r.json();
  } catch (error) {
    return null;
  }
}

async function listFiles(){
  try {
    const r = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/`);
    if(!r.ok){ return []; }
    const arr = await r.json();
    return arr.filter(x => x.type==='file' && x.name.toLowerCase().endsWith('.html') && x.name !== 'index.html');
  } catch (error) {
    return [];
  }
}

async function getLatestCommitForPath(path){
  try {
    const r = await gh(`/repos/${GH_OWNER}/${GH_REPO}/commits?path=${encodeURIComponent(path)}&per_page=1`);
    if(!r.ok) return null;
    const [commit] = await r.json();
    return commit || null;
  } catch (error) {
    return null;
  }
}

function fileSafeName(name){
  return name.replace(/\s+/g,'_').replace(/[^\w\-\.]/g,'');
}

function toBase64(arrayBuffer){
  let binary = '';
  const bytes = new Uint8Array(arrayBuffer);
  const len = bytes.byteLength;
  for(let i=0;i<len;i++) binary += String.fromCharCode(bytes[i]);
  return btoa(binary);
}

/* ---------- Upload flow ---------- */
async function uploadFile(file){
  els.status.textContent = 'Uploading…';
  const token = getToken();
  if(!token){
    els.status.textContent = 'Please sign in first.';
    return;
  }

  try {
    // First, let's verify we can access the repository
    els.status.textContent = 'Checking repository access…';
    const repoCheck = await gh(`/repos/${GH_OWNER}/${GH_REPO}`);
    console.log('Repository check response:', repoCheck.status);
    if (!repoCheck.ok) {
      const repoError = await repoCheck.json().catch(() => ({}));
      console.log('Repository check error:', repoError);
      if (repoCheck.status === 404) {
        throw new Error(`Repository ${GH_OWNER}/${GH_REPO} not found or no access. Check your token permissions.`);
      }
      throw new Error(`Repository access failed: ${repoCheck.status}`);
    }

    // Get repository info to verify branch
    const repoInfo = await repoCheck.json();
    console.log('Repository info:', repoInfo);
    console.log('Default branch:', repoInfo.default_branch);
    
    // Check if we have push permissions
    console.log('Repository permissions:', {
      admin: repoInfo.permissions?.admin,
      push: repoInfo.permissions?.push,
      pull: repoInfo.permissions?.pull
    });
    
    if (!repoInfo.permissions?.push) {
      throw new Error('Token does not have push/write permissions to this repository. Please recreate your token with "Contents" write permission.');
    }

    els.status.textContent = 'Processing file…';
    const arrayBuf = await file.arrayBuffer();
    const b64 = toBase64(arrayBuf);
    const filename = fileSafeName(file.name || 'model.html');

    // Check if the repository has any content at all
    els.status.textContent = 'Checking repository contents…';
    const contentsCheck = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/`);
    console.log('Contents check response:', contentsCheck.status);
    
    if (contentsCheck.status === 404) {
      console.log('Repository appears to be empty - this is normal for new repos');
    } else if (contentsCheck.ok) {
      const contents = await contentsCheck.json();
      console.log('Repository contents:', contents);
    }

    els.status.textContent = 'Checking if file exists…';
    // Check if file exists to pass sha for update
    let existingSha = null;
    const head = await gh(`/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(filename)}`);
    console.log('File check response:', head.status);
    if(head.ok){
      const meta = await head.json();
      existingSha = meta.sha;
      els.status.textContent = `Updating existing file: ${filename}`;
      console.log('File exists, SHA:', existingSha);
    } else {
      els.status.textContent = `Creating new file: ${filename}`;
      console.log('File does not exist, creating new');
    }

    const user = await getUser();
    // Create shorter commit messages (GitHub limit is 72 characters)
    const username = user?.login || 'user';
    const shortFilename = filename.length > 30 ? filename.substring(0, 27) + '...' : filename;
    
    // Use the repository's default branch instead of hardcoding 'main'
    const defaultBranch = repoInfo.default_branch || 'main';
    console.log('Using branch:', defaultBranch);
    
    const message = existingSha
      ? `Update ${shortFilename}`
      : `Add ${shortFilename}`;

    console.log('Commit message:', message, '(length:', message.length, ')');

    const body = {
      message,
      content: b64,
      branch: defaultBranch  // Use the actual default branch
    };
    if(existingSha) body.sha = existingSha;

    els.status.textContent = 'Uploading to GitHub…';
    const uploadUrl = `/repos/${GH_OWNER}/${GH_REPO}/contents/${encodeURIComponent(filename)}`;
    console.log('Upload URL:', uploadUrl);
    console.log('Upload body:', body);
    console.log('Token (first 10 chars):', token.substring(0, 10) + '...');

    const put = await gh(uploadUrl, {
      method:'PUT',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify(body)
    });

    console.log('Upload response status:', put.status);
    console.log('Upload response headers:', Object.fromEntries(put.headers.entries()));
    
    if(!put.ok){
      const err = await put.json().catch(()=>({}));
      console.log('Upload error:', err);
      
      // More specific error handling
      let errorMsg = err.message || `HTTP ${put.status}`;
      if (put.status === 404) {
        errorMsg = `404 Error: This usually means your token lacks 'Contents' write permission. Please:
1. Go to GitHub Settings → Personal access tokens
2. Delete your current token
3. Create a new fine-grained token
4. Select repository: handrailcreations/edrawings  
5. Under "Repository permissions", set "Contents" to "Read and write"
6. Generate and use the new token`;
      } else if (put.status === 403) {
        errorMsg = `403 Forbidden: ${err.message || 'Your token needs Contents write permission'}`;
      } else if (put.status === 422) {
        errorMsg = `422 Invalid request: ${err.message || 'Check file content and branch name'}`;
      }
      
      throw new Error(errorMsg);
    }

    els.status.textContent = 'Uploaded ✔';
    const url = PAGES_BASE + encodeURIComponent(filename);
    els.shareUrl.value = url;
    els.afterUpload.style.display = '';
    els.openBtn.href = url;

    // Refresh recent list
    renderRecent();

  } catch (error) {
    els.status.textContent = 'Upload failed: ' + error.message;
    console.error('Upload error:', error);
  }
}

/* ---------- UI wiring ---------- */
els.loginBtn.addEventListener('click', loginWithToken);
els.tokenInput.addEventListener('keypress', (e) => {
  if (e.key === 'Enter') loginWithToken();
});
els.logout.addEventListener('click', ()=>{ 
  clearToken(); 
  setSignedIn(null);
  els.status.textContent = '';
});
els.copyBtn.addEventListener('click', ()=>{
  els.shareUrl.select(); 
  navigator.clipboard.writeText(els.shareUrl.value).then(() => {
    els.status.textContent = 'Link copied to clipboard.';
  }).catch(() => {
    document.execCommand('copy');
    els.status.textContent = 'Link copied to clipboard.';
  });
});
els.refreshBtn.addEventListener('click', ()=>renderRecent());

/* Drag & drop */
['dragenter','dragover'].forEach(ev=>{
  els.dz.addEventListener(ev, e=>{ e.preventDefault(); els.dz.classList.add('drag'); });
});
['dragleave','drop'].forEach(ev=>{
  els.dz.addEventListener(ev, e=>{ e.preventDefault(); els.dz.classList.remove('drag'); });
});
els.dz.addEventListener('click', ()=>els.fi.click());
els.dz.addEventListener('drop', e=>{
  const f = e.dataTransfer?.files?.[0];
  if(f){ showSelected(f); uploadFile(f); }
});
els.fi.addEventListener('change', e=>{
  const f = e.target.files?.[0];
  if(f){ showSelected(f); uploadFile(f); }
});
function showSelected(f){
  els.sel.style.display = '';
  els.sel.textContent = `Selected: ${f.name} (${(f.size/1024/1024).toFixed(2)} MB)`;
  els.afterUpload.style.display = 'none';
  els.status.textContent = '';
}

/* ---------- Recent uploads ---------- */
async function renderRecent(){
  els.recentTbody.innerHTML = `<tr><td colspan="4" class="muted">Loading…</td></tr>`;
  const files = await listFiles();
  if(!files.length){
    els.recentTbody.innerHTML = `<tr><td colspan="4" class="muted">No uploads yet.</td></tr>`;
    return;
  }

  // Sort by latest commit date
  const rows = [];
  for(const f of files){
    const commit = await getLatestCommitForPath(f.path);
    const when = commit?.commit?.committer?.date || null;
    const uploader = (commit?.author?.login) || (commit?.committer?.login) || '—';
    rows.push({
      name: f.name,
      url: PAGES_BASE + encodeURIComponent(f.name),
      uploader, when: when ? new Date(when) : null
    });
  }
  rows.sort((a,b)=>(b.when?.getTime()||0)-(a.when?.getTime()||0));

  els.recentTbody.innerHTML = rows.map(r=>{
    const dateStr = r.when ? r.when.toLocaleString() : '—';
    return `<tr>
      <td>${r.name}</td>
      <td>${r.uploader}</td>
      <td>${dateStr}</td>
      <td><a class="link" href="${r.url}" target="_blank">Open</a></td>
    </tr>`;
  }).join('');
}

/* ---------- Boot ---------- */
(async function boot(){
  const user = await getUser();
  setSignedIn(user);
  if (user) {
    renderRecent();
  }
})();
</script>
</body>
</html>
